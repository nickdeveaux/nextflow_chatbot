name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git
    
    - name: Install Python dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
    
    - name: Run tests
      working-directory: ./backend
      env:
        # Set dummy values for tests that require these env vars
        # Tests mock actual API calls, so these are just to prevent errors
        SERVICE_ACCOUNT_PATH: ""
        GOOGLE_APPLICATION_CREDENTIALS: ""
        LLM_MODEL: "gemini-1.5-pro"
        LLM_TEMPERATURE: "0.7"
        LLM_MAX_TOKENS: "2048"
        # Ensure config.yaml can be found (it's at the repo root)
        PYTHONPATH: ${{ github.workspace }}
        # Suppress FAISS loader warnings about instruction sets
        FAISS_OPT_LEVEL: ""
      run: |
        # Skip vector store tests (they require torch/sentence-transformers)
        pytest -v --tb=short --ignore=test_vector_store.py

